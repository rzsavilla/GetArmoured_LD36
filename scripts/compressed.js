function Vector2D(a,b){this.x=a,this.y=b,this.add=function(a,b){return new Vector2D(this.x+a,this.y+b)},this.subtract=function(a,b){return new Vector2D(this.x-a,this.y-b)},this.multiply=function(a,b){return new Vector2D(this.x*a,this.y*b)},this.divide=function(a,b){return 0==a&&(a=1),0==b&&(b=1),new Vector2D(this.x/a,this.y/b)},this.sAdd=function(a){return new Vector2D(this.x+a,this.y+a)},this.sSubtract=function(a){return new Vector2D(this.x+a,this.y+a)},this.sMultiply=function(a){return new Vector2D(this.x+a,this.y+a)},this.sDivide=function(a){return 0==a&&(a=1),new Vector2D(this.x+a,this.y+a)},this.vAdd=function(a){return new Vector2D(this.x+a.x,this.y+a.y)},this.vSubtract=function(a){return new Vector2D(this.x-a.x,this.y-a.y)},this.vMultiply=function(a){return new Vector2D(this.x*a.x,this.y*a.y)},this.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},this.normalize=function(){var a=this.magnitude();return new Vector2D(this.x/a,this.y/a)},this.dot=function(a){return this.x*a.x+this.y*a.y}}function Transform(a,b,c,d,e,f){var g=[a,b,c,d,e,f];this.apply=function(a){return new Vector2D(g[0]*a.x+g[1]*a.y+g[2],g[3]*a.x+g[4]*a.y+g[5])}}function RotationMatrix(a){var b=a*(Math.PI/180),c=Math.cos(b),d=Math.sin(b);return new Transform(c,-d,0,d,c,0)}function TranslationMatrix(a,b){return new Transform(1,0,a,0,1,b)}function Timer(){var a=(new Date).getTime();this.reset=function(){a=(new Date).getTime()},this.getElapsed=function(){return(new Date).getTime()-a}}function getMousePos(a){var b=a.getBoundingClientRect();return new Vector2D(mousePos.x-b.left,mousePos.y-b.top)}function Transformable(){var a=new Vector2D(0,0),b=new Vector2D(0,0),c=new Vector2D(1,1),d=0;this.objectType="",this.setPos=function(b,c){a=new Vector2D(b,c)},this.setPosV=function(b){a=b},this.setOrigin=function(a,c){b.x=a,b.y=c},this.setRot=function(a){d=a},this.setScale=function(a,b){c.x=a,c.y=b},this.getPos=function(){return a},this.getOrigin=function(){return b},this.getRot=function(){return d},this.getScale=function(){return c}}function Movable(){Transformable.call(this);var a=new Vector2D(0,0),b=0,c=0,d=1,e=new Vector2D(.1,.1),f=new Vector2D(0,0),g=new Vector2D(0,0);this.setVelocity=function(b,c){a.x=b,a.y=c},this.setHeading=function(a,b){a instanceof Vector2D?heading=a:(heading.x=a,heading.y=b),heading=heading.normalize()},this.setfriction=function(a){e=a},this.setFrictionX=function(a){e.x=a},this.setFrictionY=function(a){e.y=a},this.setMass=function(a){d=a},this.setSpeed=function(a){c=a},this.getVelocity=function(){return g},this.getFriction=function(){return e},this.getMass=function(){return d},this.getAcceleration=function(){return b/d},this.getSpeed=function(){return c},this.move=function(a,b){this.setPos(this.getPos().x+a,this.getPos().y+b)},this.applyForce=function(a,b){f.x+=a/this.getMass(),f.y+=b/this.getMass()},this.updateMove=function(a){var b=new Vector2D(-f.x*e.x,-f.y*e.y);b.x=b.x*a,f=f.vAdd(b),g=f,g.x>-.1&&g.x<.1&&(g.x=0),g.y>-.1&&g.y<.1&&(g.y=0),this.move(g.x*a,g.y*a)}}function Shape(){Movable.call(this);var a="Red";this.setColour=function(b){a=b},this.getColour=function(){return a}}function Rectangle(a,b,c,d){Shape.call(this),this.setPos(a,b),this.balls=[new Circle(0,0,5),new Circle(0,0,5),new Circle(0,0,5),new Circle(0,0,5)];var e=new Vector2D(c,d);this.setSize=function(a,b){e.x=a,e.y=b},this.setWidth=function(a){e.x=a},this.setHeight=function(a){e.y=a},this.getSize=function(){return e},this.getWidth=function(){return e.x},this.getHeight=function(){return e.y},this.draw=function(a){a.save(),a.translate(this.getPos().x,this.getPos().y),a.rotate(this.getRot()*(Math.PI/180)),a.fillStyle=this.getColour(),a.fillRect(-this.getOrigin().x*this.getScale().x,-this.getOrigin().y*this.getScale().y,this.getWidth()*this.getScale().x,this.getHeight()*this.getScale().y),a.restore();for(var b=0;b<this.balls.length;b++)this.balls[b].draw(a)}}function Circle(a,b,c){Shape.call(this),this.setPos(a,b),this.setColour("Blue");var c=c;this.setRadius=function(a){c=a},this.getRadius=function(){return c},this.draw=function(a){a.fillStyle=this.getColour(),a.beginPath(),a.arc(this.getPos().x,this.getPos().y,c,0,2*Math.PI),a.fill()}}function AABB(a,b,c,d){Rectangle.call(this),this._roId=uniq++,this.setPos(a,b),this.setSize(c,d),this.getExtents=function(){return new Vector2D(this.getWidth()/2,this.getHeight()/2)},this.collision=function(a){var b=this.getPos().subtract(this.getOrigin().x,this.getOrigin().y),c=a.getPos().subtract(a.getOrigin().x,a.getOrigin().y);new Vector2D(this.getWidth()*this.getScale().x,this.getHeight()*this.getScale().y),new Vector2D(a.getWidth()*a.getScale().x,a.getHeight()*a.getScale().y);return b.x<c.x+a.getWidth()*a.getScale().x&&b.x+this.getWidth()*this.getScale().x>c.x&&b.y<c.y+a.getHeight()*a.getScale().y&&b.y+this.getHeight()*this.getScale().x>c.y}}function BC(a,b,c){Circle.call(this),this.setPos(a,b),this.setRadius(c),this.collision=function(a){if(a instanceof BC){var b=this.getPos().x-a.getPos().x,c=this.getPos().y-a.getPos().y,d=Math.sqrt(b*b+c*c);return d<this.getRadius()+a.getRadius()}if(a instanceof AABB){var d=new Vector2D(a.getPos().x-this.getPos().x,a.getPos().y-this.getPos().y),e=new Vector2D(0,0);d.x>=0?e.x=Math.min(d.x,a.getWidth()/2):d.x<0&&(e.x=Math.max(d.x,-(a.getWidth()/2))),d.y>=0?e.y=Math.min(d.y,a.getHeight()/2):d.y<0&&(e.y=Math.max(d.y,-(a.getHeight()/2)));var f=d.vSubtract(e),g=f.magnitude()-this.getRadius();return g<=0}return!1}}function OBB(a,b,c,d){Rectangle.call(this),this.setPos(a,b),this.setSize(c,d),this.collision=function(a){if(a instanceof AABB){for(var b=new RotationMatrix(-this.getRot()),c=new Vector2D(this.getWidth()*this.getScale().x/2,this.getHeight()*this.getScale().y/2),d=new Vector2D(a.getWidth()*a.getScale().x/2,a.getHeight()*a.getScale().y/2),e=[new Vector2D(-c.x,-c.y),new Vector2D(+c.x,-c.y),new Vector2D(+c.x,+c.y),new Vector2D(-c.x,+c.y)],f=[new Vector2D(-d.x,-d.y),new Vector2D(+d.x,-d.y),new Vector2D(+d.x,+d.y),new Vector2D(-d.x,+d.y)],g=new RotationMatrix(this.getRot()),h=new RotationMatrix(a.getRot()),i=0;i<e.length;i++)e[i]=e[i].vSubtract(this.getOrigin().vSubtract(c)),e[i]=g.apply(e[i]),e[i]=e[i].add(this.getPos().x,this.getPos().y),f[i]=f[i].vSubtract(a.getOrigin().vSubtract(d)),f[i]=h.apply(f[i]),f[i]=f[i].add(a.getPos().x,a.getPos().y);for(var j=[RotationMatrix(this.getRot()).apply(new Vector2D(1,0)).normalize(),RotationMatrix(this.getRot()).apply(new Vector2D(0,1)).normalize(),RotationMatrix(a.getRot()).apply(new Vector2D(1,0)).normalize(),RotationMatrix(a.getRot()).apply(new Vector2D(0,1)).normalize()],i=0;i<j.length;i++){for(var k=99999999,l=-99999999,m=99999999,n=-99999999,o=0;o<4;o++){var p=j[i].dot(e[o]);p<k&&(k=p),p>l&&(l=p);var p=j[i].dot(f[o]);p<m&&(m=p),p>n&&(n=p)}if(!(m<=l&&n>=k))return!1}return!0}if(a instanceof BC){var b=new RotationMatrix(-this.getRot()),q=a.getPos().vSubtract(this.getPos());q=b.apply(q);var r=new Vector2D(this.getWidth()/2,this.getHeight()/2),t=([new Vector2D(-r.x,-r.y),new Vector2D(+r.x,-r.y),new Vector2D(+r.x,+r.y),new Vector2D(-r.x,+r.y)],q),u=new Vector2D(0,0);t.x>=0?u.x=Math.min(t.x,r.x):t.x<0&&(u.x=Math.max(t.x,-r.x)),t.y>=0?u.y=Math.min(t.y,r.y):t.y<0&&(u.y=Math.max(t.y,-r.y));var v=new Vector2D(t.x-u.x,t.y-u.y),w=Math.sqrt(v.x*v.x+v.y*v.y)-a.getRadius();return w<=0}if(a instanceof OBB){for(var c=new Vector2D(this.getWidth()/2,this.getHeight()/2),d=new Vector2D(a.getWidth()/2,a.getWidth()/2),e=[new Vector2D(-c.x,-c.y),new Vector2D(+c.x,-c.y),new Vector2D(+c.x,+c.y),new Vector2D(-c.x,+c.y)],f=[new Vector2D(-d.x,-d.y),new Vector2D(+d.x,-d.y),new Vector2D(+d.x,+d.y),new Vector2D(-d.x,+d.y)],g=new RotationMatrix(this.getRot()),h=new RotationMatrix(a.getRot()),i=0;i<e.length;i++)e[i]=e[i].vSubtract(this.getOrigin().vSubtract(c)),e[i]=g.apply(e[i]),e[i]=e[i].add(this.getPos().x,this.getPos().y),f[i]=f[i].vSubtract(a.getOrigin().vSubtract(d)),f[i]=h.apply(f[i]),f[i]=f[i].add(a.getPos().x,a.getPos().y);for(var j=[RotationMatrix(this.getRot()).apply(new Vector2D(1,0)).normalize(),RotationMatrix(this.getRot()).apply(new Vector2D(0,1)).normalize(),RotationMatrix(a.getRot()).apply(new Vector2D(1,0)).normalize(),RotationMatrix(a.getRot()).apply(new Vector2D(0,1)).normalize()],i=0;i<4;i++){for(var k=99999999,l=-99999999,m=99999999,n=-99999999,o=0;o<4;o++){var p=j[i].dot(e[o]);p<k&&(k=p),p>l&&(l=p);var p=j[i].dot(f[o]);p<m&&(m=p),p>n&&(n=p)}if(!(m<=l&&n>=k))return!1}return!0}}}function Sprite(){Movable.call(this);var a=new Image,b=new Vector2D(0,0);this.setSize=function(a,c){b.x=a,b.y=c},this.setImage=function(b){a=b,this.setSize(b.width,b.height)},this.getSize=function(){return b},this.getImage=function(){return a},this.draw=function(b){b.drawImage(a,this.getPos().x-this.getOrigin().x,this.getPos().y-this.getOrigin().y)}}function Frame(a,b){this.top=a,this.size=b}function Animation(a,b){this.frames=[],this.spriteSheet=b,this.speed=a,this.spriteSheet=b,this.setSpriteSheet=function(a){this.spriteSheet=a},this.set=function(a,b,c,d,e){for(var f=new Vector2D(b,c),g=0;g<a;g++){f.x>=this.spriteSheet.width&&(f.x=0,f.y+=e);var h=new Vector2D(f.x,f.y);this.frames.push(new Frame(h,new Vector2D(d,e))),f.x+=d}},this.addFrame=function(a,b,c,d){var e=new Vector2D(a,b),f=new Vector2D(c,d);this.frames.push(new Frame(e,f))}}function AnimatedSprite(){Movable.call(this);var d=(new Vector2D(0,0),new Vector2D(0,0),0),e=.2,f=new Timer,g=new Animation;this.destroy=!1;var h=!0;this.opacity=1,this.bbLeft=new AABB,this.bbRight=new AABB,this.bbTop=new AABB,this.bbBot=new AABB,this.bb=new AABB,this.bb.setColour("white"),this.collidable=!1,this._roId=uniq++,this.topHit=!1,this.setAnimation=function(a){g=a,this.setAnimSpeed(g.speed),d=0},this.getAnimation=function(){return g},this.getCurrFrame=function(){return d},this.getFrameSize=function(){return g.frames.length>0?g.frames[d].size:new Vector2D(0,0)},this.play=function(a){h=a},this.reset=function(){d=0},this.nextFrame=function(){f.getElapsed()/1e3>=g.speed&&(d<g.frames.length-1?d+=1:d=0,f.reset())},this.setAnimSpeed=function(a){e=a},this.draw=function(a){this.nextFrame();var b=this.getAnimation().frames[this.getCurrFrame()];a.save(),a.translate(this.getPos().x,this.getPos().y),a.scale(this.getScale().x,this.getScale().y),a.rotate(this.getRot()*(Math.PI/180)),a.translate(-this.getPos().x,-this.getPos().y),a.globalAlpha=this.opacity,a.drawImage(this.getAnimation().spriteSheet,b.top.x,b.top.y,b.size.x,b.size.y,this.getPos().x-this.getOrigin().x,this.getPos().y-this.getOrigin().y,b.size.x,b.size.y),a.restore()}}function loadPlayerAnimations(){var a,b=.09;a=new Animation(0,spriteSheet),a.addFrame(0,0,14,46),playerAnim.push(a),a=new Animation(b,spriteSheet),a.addFrame(32,0,14,46),a.addFrame(47,0,20,46),a.addFrame(67,0,16,46),a.addFrame(83,0,14,46),a.addFrame(97,0,14,46),a.addFrame(111,0,14,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(14,0,16,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(0,46,14,46),playerAnim.push(a),a=new Animation(b,spriteSheet),a.addFrame(32,46,14,46),a.addFrame(47,46,20,46),a.addFrame(67,46,16,46),a.addFrame(83,46,14,46),a.addFrame(97,46,14,46),a.addFrame(111,46,14,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(14,46,18,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(0,92,15,46),playerAnim.push(a),a=new Animation(b,spriteSheet),a.addFrame(33,92,15,46),a.addFrame(48,92,20,46),a.addFrame(68,92,16,46),a.addFrame(84,92,15,46),a.addFrame(99,92,15,46),a.addFrame(114,92,15,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(15,92,18,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(0,138,15,46),playerAnim.push(a),a=new Animation(b,spriteSheet),a.addFrame(33,138,15,46),a.addFrame(48,138,20,46),a.addFrame(68,138,16,46),a.addFrame(84,138,15,46),a.addFrame(99,138,15,46),a.addFrame(114,138,15,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(15,138,18,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(0,184,15,46),playerAnim.push(a),a=new Animation(b,spriteSheet),a.addFrame(33,184,15,46),a.addFrame(48,184,20,46),a.addFrame(68,184,16,46),a.addFrame(85,184,15,46),a.addFrame(100,184,15,46),a.addFrame(115,184,15,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(15,184,18,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(0,230,15,46),playerAnim.push(a),a=new Animation(b,spriteSheet),a.addFrame(33,230,15,46),a.addFrame(48,230,20,46),a.addFrame(68,230,16,46),a.addFrame(85,230,15,46),a.addFrame(100,230,15,46),a.addFrame(115,230,15,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(15,230,18,46),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(0,276,16,45),playerAnim.push(a),a=new Animation(b,spriteSheet),a.addFrame(38,276,16,45),a.addFrame(54,276,20,45),a.addFrame(74,276,17,45),a.addFrame(91,276,16,45),a.addFrame(107,276,16,45),a.addFrame(123,276,16,45),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(16,276,22,45),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(0,321,16,45),playerAnim.push(a),a=new Animation(b,spriteSheet),a.addFrame(38,321,16,45),a.addFrame(54,321,20,45),a.addFrame(74,321,17,45),a.addFrame(91,321,16,45),a.addFrame(107,321,16,45),a.addFrame(123,321,16,45),playerAnim.push(a),a=new Animation(0,spriteSheet),a.addFrame(16,321,22,45),playerAnim.push(a),a=new Animation(.1,spriteSheet),a.set(8,0,366,14,46),playerAnim.push(a),a=new Animation(.1,spriteSheet),a.set(8,0,412,14,46),playerAnim.push(a),a=new Animation(.1,spriteSheet),a.set(8,0,458,15,46),playerAnim.push(a),a=new Animation(.1,spriteSheet),a.set(8,0,490,15,46),playerAnim.push(a),a=new Animation(.1,spriteSheet),a.set(8,0,536,16,45),playerAnim.push(a),a=new Animation(.1,spriteSheet),a.set(8,0,490,16,45),playerAnim.push(a),console.log(playerAnim.length)}function loadBlobAnim(){var a,b=.15;a=new Animation(b,blobImage),a.set(6,0,0,15,11),blobAnim.push(a),a=new Animation(b,blobImage),a.set(6,0,11,15,11),blobAnim.push(a),a=new Animation(b,blobImage),a.set(7,0,22,15,18),blobAnim.push(a),a=new Animation(b,blobImage),a.set(7,0,40,15,18),blobAnim.push(a)}function Text(a,b,c,d){Transformable.call(this);var e=c,f=d;this.colour="red",this.setString=function(a){e=a},this.setFont=function(a){f=a},this.draw=function(c){c.font=f,c.fillStyle=this.colour,ctx.textAlign="center",c.fillText(e,a,b)}}function LoadingScreen(){var a=new Text(canvas.width/2,canvas.height/2,"LOADING","100px Arial");a.colour="white",this.draw=function(b){b.fillStyle="black",b.fillRect(0,0,canvas.width,canvas.height),a.draw(b)}}function PauseScreen(){var a=new Text(canvas.width/2,canvas.height/2,"PAUSED","100px Arial");a.colour="white",this.draw=function(b){b.fillStyle="black",b.fillRect(0,0,canvas.width,canvas.height),a.draw(b)}}function EndScreen(){var a=new Text(canvas.width/2,canvas.height/2,"Thanks for Playing","50px Arial");a.colour="white",this.draw=function(b){b.fillStyle="black",b.fillRect(0,0,canvas.width,canvas.height),a.draw(b)}}function Platform(a,b,c){AnimatedSprite.call(this),this.setPos(b,c);var d=new Animation(0,tileSheet);this.bb.setPos(b,c),this.bb.setWidth(32),this.bb.setHeight(32),this.type="solid",this.collidable=!0,1==a?d.addFrame(0,0,32,32):2==a?d.addFrame(32,0,32,32):3==a?d.addFrame(64,0,32,32):4==a?d.addFrame(96,0,32,32):5==a?d.addFrame(128,0,32,32):6==a?(d.addFrame(160,0,32,17),this.bb.setPos(b,c+2),this.bb.setWidth(32),this.bb.setHeight(3),this.type="floating"):7==a?(d.addFrame(192,0,32,17),this.bb.setPos(b,c+1),this.bb.setWidth(32),this.bb.setHeight(3),this.type="floating"):8==a?(d.addFrame(224,0,32,17),this.bb.setPos(b,c+1),this.bb.setWidth(32),this.bb.setHeight(3),this.type="floating"):9==a?d.addFrame(256,0,32,32):10==a?d.addFrame(288,0,32,32):11==a?(d.addFrame(320,0,32,32),this.collidable=!1):12==a?(d.addFrame(0,32,32,32),this.type="background",this.collidable=!1):13==a?(d.addFrame(32,32,32,32),this.type="background",this.collidable=!1):14==a?d.addFrame(64,32,32,32):15==a?d.addFrame(96,32,32,32):16==a?d.addFrame(128,32,32,32):17==a?(d.addFrame(160,32,32,32),this.type="background",this.collidable=!1):18==a?d.addFrame(192,32,32,32):19==a?d.addFrame(224,32,32,32):20==a?d.addFrame(256,32,32,32):21==a?d.addFrame(288,32,32,32):23==a||24==a||25==a?(d.speed=.2,d.addFrame(0,64,32,32),d.addFrame(32,64,32,32),d.addFrame(64,64,32,32),this.type="background",this.collidable=!1):26==a?(this.type="death",d.addFrame(0,0,0,0)):27==a?d.addFrame(0,0,0,0):34==a?(d.addFrame(0,96,32,32),this.bb.setHeight(7)):45==a?(d.addFrame(0,128,32,32),this.type="background",this.collidable=!1):46==a?(d.addFrame(32,128,32,32),this.type="background",this.collidable=!1):56==a?(d.addFrame(0,160,32,32),this.type="background",this.collidable=!1):57==a?(d.addFrame(32,160,32,32),this.type="background",this.collidable=!1):67==a?(d.addFrame(0,192,32,32),this.type="background",this.collidable=!1):68==a?(d.addFrame(32,192,32,32),this.type="background",this.collidable=!1):47==a?(d.addFrame(64,128,32,32),this.type="background",this.collidable=!1):48==a?(d.addFrame(96,128,32,32),this.type="background",this.collidable=!1):58==a?(d.addFrame(64,160,32,32),this.type="background",this.collidable=!1):59==a?(d.addFrame(96,160,32,32),this.type="background",this.collidable=!1):69==a?(d.addFrame(64,192,32,32),this.type="background",this.collidable=!1):70==a?(d.addFrame(96,192,32,32),this.type="background",this.collidable=!1):(d.addFrame(0,0,0,0),this.type="background",this.collidable=!1),this.setAnimation(d)}function PickUp(){AnimatedSprite.call(this),this.collected=!1,this.collidable=!0}function ShieldPickUp(a,b){PickUp.call(this),this.setPos(a,b),this.bb.setSize(32,32),this.bb.setPos(a,b),this.setAnimation(shieldAnim),this.update=function(){}}function Portal(a,b){AnimatedSprite.call(this),this.collidable=!0,this.setPos(a,b),this.bb.setSize(32,61),this.bb.setPos(a,b),this.setAnimation(portalInactive),this.activated=!1,this.update=function(){this.activated&&this.getAnimation()!=portalActive&&this.setAnimation(portalActive)}}function Entity(){AnimatedSprite.call(this);var a=0,b=500,c=!1,d=10,e=0,f="right",g=!1;this.onGround=!1,this._roId=uniq++,this.setJumpForce=function(a){b=a},this.setJumpTick=function(a){d=a},this.setFacing=function(a){f=a},this.isJumping=function(){return c},this.isMoving=function(){return g},this.isFacing=function(){return f},this.onFloor=function(){return this.onGround},this.moveLeft=function(){f="left",this.applyForce(-this.getSpeed(),0)},this.moveRight=function(){f="right",this.applyForce(this.getSpeed(),0)},this.moveUp=function(){this.applyForce(0,-this.getSpeed()),g=!0},this.moveDown=function(){this.applyForce(0,this.getSpeed()),g=!0},this.jump=function(){c||(this.topHit=!1,this.onGround&&(c=!0,e=0,this.onGround=!1))},this.impulseCollision=function(b){if(this.bb.collision(b.bb)){var c=this.getPos().vSubtract(b.getPos()),d=c.normalize();this.setPos(this.getPos().x+d.x,this.getPos().y+d.y),b.setPos(b.getPos().x-d.x,b.getPos().y-d.y);var e=this.getVelocity().vSubtract(b.getVelocity()),f=e.dot(d)*a;f/=1/this.getMass()+1/b.getMass();var g=this.getVelocity().vAdd(d.sMultiply(f)).sDivide(this.getMass()),h=b.getVelocity().vSubtract(d.sMultiply(f)).sDivide(b.getMass());g=g.vSubtract(this.getVelocity()),h=h.vSubtract(b.getVelocity()),this.applyForce(g.x,g.y),b.applyForce(h.x,h.y)}},this.impulseImmovable=function(b){if(this.bb.collision(b.bb)){var c=this.getPos().vSubtract(b.getPos()),d=c.normalize(),e=this.getVelocity().dot(d),f=this.getVelocity().vSubtract(d.sMultiply(e).sMultiply(a));return this.setVelocity(f.x,f.y),!0}return!1},this.updateFrameBB=function(){var a=this.getFrameSize().divide(2,2);this.setOrigin(a.x,a.y);var b=this.getPos().vSubtract(this.getOrigin());this.bbTop.setSize(a.x/1.2,2),this.bbBot.setSize(a.x/1.2,2),this.bbLeft.setSize(2,a.y),this.bbRight.setSize(2,a.y),this.bbTop.setPos(b.x+a.x,this.getPos().y-a.y),this.bbBot.setPos(b.x+a.x,this.getPos().y+a.y),this.bbLeft.setPos(b.x-1,this.getPos().y),this.bbRight.setPos(b.x+2*a.x,this.getPos().y),this.bbTop.setOrigin(this.bbTop.getWidth()/2,this.bbTop.getHeight()/2),this.bbBot.setOrigin(this.bbBot.getWidth()/2,this.bbBot.getHeight()/2),this.bbLeft.setOrigin(0,this.bbLeft.getHeight()/2),this.bbRight.setOrigin(0,this.bbRight.getHeight()/2),this.bb.setPos(this.getPos().x,this.getPos().y)},this.updateEntity=function(a){this.getAnimation().frames[this.getCurrFrame()];this.topHit&&(c=!1),c&&(this.onGround=!1,this.applyForce(0,-(b/d)*this.getMass()),e++,e>=d&&(c=!1)),this.updateMove(a)}}function Enemy(){Entity.call(this),this.setMass(50),this.setSpeed(200),this.setFrictionX(15),this.range=150,this.collidable=!0,this.bbSet=!1,this.spot=function(a){var b=a.getPos().vSubtract(this.getPos()),c=Math.sqrt(b.x*b.x+b.y*b.y);return Math.abs(c)<this.range},this.updateEnemy=function(a){"right"==this.isFacing()?this.moveRight():"left"==this.isFacing()&&this.moveLeft(),this.updateEntity(a),this.updateMove(a)}}function Blob(a,b){Enemy.call(this),this.setAnimation(blobAnim[0]),this.setPos(a,b),this.setSpeed(500),this.setJumpForce(500),this.setMass(20);var a=7.5,b=7.5;this.bb.setSize(15,18),this.bb.setOrigin(7.5,9),this.bbTop.setSize(a,2),this.bbBot.setSize(a,2),this.bbLeft.setSize(3,2),this.bbRight.setSize(3,2),this.bbTop.setOrigin(a/2,b/2),this.bbBot.setOrigin(a/2,b/2),this.bbLeft.setOrigin(a,b),this.bbRight.setOrigin(a,b),this.setOrigin(a,9),this.updateBB=function(){this.bbBot.setPos(this.getPos().x,this.getPos().y+5),this.bbTop.setPos(this.getPos().x,this.getPos().y-5),this.bbLeft.setPos(this.getPos().x,this.getPos().y+2),this.bbRight.setPos(this.getPos().x+2*this.getOrigin().x-2,this.getPos().y+2),this.bb.setPos(this.getPos().x,this.getPos().y)},this.update=function(a){"right"==this.isFacing()?this.isJumping()?this.getAnimation()!=blobAnim[2]&&this.setAnimation(blobAnim[2]):this.getAnimation()!=blobAnim[0]&&this.setAnimation(blobAnim[0]):"left"==this.isFacing()&&(this.isJumping()?this.getAnimation()!=blobAnim[3]&&this.setAnimation(blobAnim[3]):this.getAnimation()!=blobAnim[1]&&this.setAnimation(blobAnim[1])),this.updateEnemy(a),this.updateFrameBB()}}function Goblin(a,b){Enemy.call(this)}function Player(a,b){Entity.call(this),this.armourLevel=0,this.collidable=!0,this.objectType="player",this.health=10,this.invulnerable=!1,this.attacking=!1,this.shoot=!1,this.death=!1,this.setPos(a,b),this.setSpeed(2e3),this.setMass(50),this.setFrictionX(15),this.setJumpTick(10),this.setJumpForce(1e3);var a=14,b=46;this.bb.setSize(a,b),this.bb.setOrigin(a/2,b),this.bb.setRot(this.getRot()),this.bb.setScale(this.getScale().x,this.getScale().y),this.bbSet=!1;var c=new Timer;c.reset();var d=0;this.attack=function(){this.attacking||(this.attacking=!0)},this.armourUp=function(){this.armourLevel++},this.takeDamage=function(a){this.invulnerable||(this.health-=a,this.invulnerable=!0,d=0)},this.setAnimation(playerAnim[0]),this.updateBB=function(){var a=this.getPos();this.bbTop.setPos(a.x,this.getPos().y-50),this.bbBot.setPos(a.x,this.getPos().y-2),this.bbLeft.setPos(a.x-2-5,this.getPos().y-25),this.bbRight.setPos(a.x+5,this.getPos().y-25),this.bbLeft.setOrigin(0,this.bbLeft.getHeight()/2),this.bbRight.setOrigin(0,this.bbRight.getHeight()/2)},this.update=function(a){this.invulnerable&&c.getElapsed()>100&&(d<20?d%2?this.opacity=1:this.opacity=.1:(this.opacity=1,this.invulnerable=!1),c.reset(),d++),this.bb.setPos(this.getPos().x,this.getPos().y),this.bbSet||(this.bbTop.setSize(5,2),this.bbBot.setSize(5,2),this.bbLeft.setSize(2,35),this.bbRight.setSize(2,35),this.bbTop.setOrigin(this.bbTop.getWidth()/2,this.bbTop.getHeight()/2),this.bbBot.setOrigin(this.bbBot.getWidth()/2,this.bbBot.getHeight()/2),this.bbSet=!0);var b=this.getAnimation().frames[this.getCurrFrame()];this.setOrigin(b.size.x/2,b.size.y),this.updateEntity(a),this.updateBB();var e=0;if(1==this.armourLevel?e=6:2==this.armourLevel?e=12:3==this.armourLevel&&(e=18),spaceKey&&(this.jump(),spaceKey=!1),aKey?(this.isJumping()||this.getAnimation()!=playerAnim[e+4]&&this.setAnimation(playerAnim[e+4]),this.moveLeft()):dKey&&(this.isJumping()||this.getAnimation()!=playerAnim[e+1]&&this.setAnimation(playerAnim[e+1]),this.moveRight()),this.attacking){var f;"left"==this.isFacing()?f=0:"right"==this.isFacing&&(f=1),1==this.armourLevel?this.getAnimation()!=this.setAnimation(28+f)&&this.setAnimation(24+f):2==this.armourLevel?this.getAnimation()!=this.setAnimation(28+f)&&this.setAnimation(26+f):3==this.armourLevel&&this.getAnimation()!=this.setAnimation(28+f)&&this.setAnimation(28+f),5==this.getCurrFrame()&&(this.shoot=!0,this.attacking=!1),this.getCurrFrame()>=7&&(this.attacking=!1)}else this.onFloor()?this.getVelocity().x<1&&this.getVelocity().x>-1&&("left"==this.isFacing()?this.getAnimation()!=playerAnim[e+3]&&this.setAnimation(playerAnim[e+3]):"right"==this.isFacing()&&this.getAnimation()!=playerAnim[e]&&this.setAnimation(playerAnim[e])):"left"==this.isFacing()?this.getAnimation()!=playerAnim[e+5]&&this.setAnimation(playerAnim[e+5]):this.getAnimation()!=playerAnim[e+2]&&this.setAnimation(playerAnim[e+2])}}function platformCollision(a,b){a.bbBot.collision(b.bb)?(a.applyForce(0,-Math.abs(a.getVelocity().y)*a.getMass()),a.onGround=!0):a.bbTop.collision(b.bb)?(a.setPos(a.getPos().x,a.getPos().y+5),a.applyForce(0,Math.abs(a.getVelocity().y)),a.topHit=!0):a.topHit=!1,"floating"!=b.type&&(a.bbLeft.collision(b.bb)?(a instanceof Enemy&&a.setFacing("right"),a.setPos(a.getPos().x+1,a.getPos().y),a.applyForce(Math.abs(a.getVelocity().x)*a.getMass(),0)):a.bbRight.collision(b.bb)&&(a instanceof Enemy&&a.setFacing("left"),a.setPos(a.getPos().x-1,a.getPos().y),a.applyForce(-(Math.abs(a.getVelocity().x)*a.getMass()),0)))}function setMap(a,b){b.width=a.width,b.height=a.height,b.tilewidth=a.tilewidth,b.tileheight=a.tileheight,b.size=new Vector2D(b.width*b.tilewidth,b.height*b.tileheight);for(var c=0;c<a.layers.length;c++){var d=a.layers[c],e=new Layer;e.type=d.type,e.offset.x=d.x,e.offset.x=d.y;var f=0,g=new Vector2D(0,0);if("tilelayer"==d.type)for(var h=d.data,i=1;i<a.height+1;i++){for(var j=1;j<a.width+1;j++){var k=h[f];if(0!=k){var l=new Platform(k,g.x,g.y);l.collidable&&b.collidables.push(l),e.tiles.push(l)}g.x+=a.tilewidth,f++}g.x=0,g.y+=a.tileheight}else if("objectgroup"==d.type)for(var n,o,m=d.objects,i=0;i<m.length;i++)n=m[i].type,"Player"==n?(b.player=new Player(m[i].x,m[i].y),b.collidables.push(b.player),console.log("player loaded")):"ShieldPickUp"==n?(o=new ShieldPickUp(m[i].x,m[i].y),b.pickups.push(o),o.collidable&&b.collidables.push(o)):"Blob"==n?(o=new Blob(m[i].x,m[i].y),b.enemies.push(o),o.collidable&&b.collidables.push(o)):"Portal"==n&&(o=new Portal(m[i].x,m[i].y),b.portal=o,o.collidable&&b.collidables.push(o));b.layers.push(e)}console.log("Loading Complete"),loaded=!0}function loadLevel(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.onreadystatechange=function(){if(4==c.readyState&&"200"==c.status){var a=c.responseText;setMap(JSON.parse(a),b)}else console.log("loading Level"),loaded=!1},c.send(null)}function Layer(){this.type,this.offset=new Vector2D(0,0),this.tiles=[],this.objects=[],this.draw=function(a){for(var b=0;b<this.tiles.length;b++){var c=this.tiles[b].getPos();c.x>=view.getBX().x&&c.x<=view.getBX().y&&this.tiles[b].draw(a)}}}function collisionCheck(a){for(var b,c,d=0;d<a.length;d++)b=a[d][0],c=a[d][1],b instanceof Entity?c instanceof Platform?("death"==c.type&&(console.log("DEATH"),b instanceof Player&&(b.death=!0)),platformCollision(b,c)):c instanceof Enemy?b instanceof Player&&b.takeDamage():c instanceof ShieldPickUp?b instanceof Player&&(c.collected||(b.armourUp(),c.collected=!0,c.destroy=!0)):c instanceof Portal&&b instanceof Player&&c.activated&&(nextLevel=!0):c instanceof Entity&&(b instanceof Platform?("death"==b.type&&(console.log("DEATH"),c instanceof Player&&(c.death=!0)),platformCollision(c,b)):b instanceof Enemy?c instanceof Player&&c.takeDamage():b instanceof ShieldPickUp?c instanceof Player&&(b.collected||(c.armourUp(),b.collected=!0,b.destroy=!0)):b instanceof Portal&&c instanceof Player&&b.activated&&(nextLevel=!0))}function Map(){this.width,this.height,this.tilewidth,this.tileheight,this.layers=[],this.size=new Vector2D(0,0),this.player=new Player,this.pickups=[],this.enemies=[],this.platforms=[],this.collidables=[],this.portal=new Portal,this.detector=new BroadPhase.HashGrid(1024,640,32,32),this.update=function(a){var b=20;this.player.applyForce(0,b*this.player.getMass());for(var c=0;c<this.enemies.length;c++)this.enemies[c].applyForce(0,b*this.enemies[c].getMass());this.layers.length>0&&this.platforms.length<=0&&(this.platforms=this.layers[0].tiles);for(var d=0;d<this.enemies.length;d++)this.enemies[d].spot(this.player)&&(this.enemies[d].isJumping()||this.enemies[d].jump(),this.enemies[d].getPos().x<this.player.getPos().x?this.enemies[d].setFacing("right"):this.enemies[d].setFacing("left"));collisionCheck(this.collisions=this.detector.check(this.collidables));for(var d=0;d<this.enemies.length;d++)this.enemies[d].update(a);this.player.shoot&&(this.player.shoot=!1,console.log("Shoot")),this.player.update(a),3==this.player.armourLevel&&(this.portal.activated=!0);for(var d=0;d<this.pickups.length;d++);this.portal.update()},this.draw=function(a){for(var b=0;b<this.layers.length;b++)this.layers[b].draw(a);for(var b=0;b<this.pickups.length;b++)this.pickups[b].collected||this.pickups[b].draw(a);for(var b=0;b<this.enemies.length;b++)this.enemies[b].draw(a);this.portal.draw(a),this.player.draw(a)}}function View(a,b,c,d,e,f,g,h){this.pos=new Vector2D(a,b),this.size=new Vector2D(c,d),this.origin=new Vector2D(e,f),this.bounds=new Vector2D(g,h),this.bX=new Vector2D(this.pos.x+this.bounds,this.pos.x+this.bounds),this.getBX=function(){return new Vector2D(this.x-32,this.x+2*this.bounds.x)},this.getBY=function(){return new Vector2D(this.y,this.y+2*this.bounds.y)}}function Scene(){var a=new Map,b=new LoadingScreen,c=new PauseScreen,d=new EndScreen,e=1,f=!1,g=!1,h=new Timer;view=new View,view.bounds.x=canvas.width/2,view.bounds.y=canvas.height/2,this.initialize=function(){nextLevel=!1,h.reset(),loaded=!1,g=!1,a=new Map,1==e?loadLevel("../levels/level1.json",a):2==e?loadLevel("../levels/level2.json",a):3==e?loadLevel("../levels/level3.json",a):4==e&&loadLevel("../levels/level4.json",a)},this.update=function(b){loaded&&h.getElapsed()/1e3>3&&(escKey&&(f=!f,escKey=!1),f||(key1?1!=e&&(e=1,this.initialize()):key2&&2!=e&&(e=2,this.initialize()),a.update(b)),g||(a.detector=new BroadPhase.HashGrid(a.width,a.height,32,32),g=!0),(1==nextLevel||jKey)&&(e++,this.initialize()),a.player.death&&this.initialize())},this.draw=function(g){loaded&&h.getElapsed()/1e3>3&&(f||(g.save(),view.x=a.player.getPos().x-view.bounds.x,view.y=a.player.getPos().y-view.bounds.y,view.x<0?view.x=0:view.x+view.bounds.x-96>a.size.x-view.bounds.x&&(view.x=a.size.x-2*view.bounds.x+96),view.y<0?view.y=0:view.y+view.bounds.y>a.size.y-view.bounds.y&&(view.y=a.size.y-2*view.bounds.y),g.translate(-view.x,-view.y),a.layers.length>0&&a.draw(g),g.restore())),(!loaded||h.getElapsed()/1e3<2)&&b.draw(g),f&&c.draw(g),5==e&&d.draw(g)}}function update(a){timer.getElapsed()>1e3&&timer.reset(),scene.update(a)}function render(){ctx.save(),ctx.fillStyle="#ccf3ff",ctx.fillRect(0,0,canvas.width,canvas.height),scene.draw(ctx),ctx.restore()}function loop(){var a;a=1/60,update(a),updateTimer.reset(),render(),window.requestAnimationFrame(loop),timer.reset()}var wKey=!1,sKey=!1,aKey=!1,dKey=!1,spaceKey=!1,escKey=!1,jKey=!1,key1=!1,key2=!1;document.addEventListener("keydown",function(a){var b=!0;27==a.keyCode?escKey=b:87==a.keyCode?wKey=b:83==a.keyCode||(65==a.keyCode?aKey=b:68==a.keyCode?dKey=b:32==a.keyCode?spaceKey=b:49==a.keyCode||50==a.keyCode||74==a.keyCode)}),document.addEventListener("keyup",function(a){var b=!1;27==a.keyCode?escKey=b:87==a.keyCode?wKey=b:83==a.keyCode||(65==a.keyCode?aKey=b:68==a.keyCode?dKey=b:32==a.keyCode?spaceKey=b:49==a.keyCode?key1=b:50==a.keyCode?key2=b:74==a.keyCode&&(jKey=b))}),window.onkeydown=function(a){return!(32==a.keyCode&&a.target==document.body)};var leftClick=!1,rightClick=!1,middleClick=!1,mousePos=new Vector2D(0,0);document.addEventListener("mousedown",function(a){
1==a.which||2==a.which||3==a.which}),document.addEventListener("mouseup",function(a){1==a.which||2==a.which||3==a.which}),document.addEventListener("mousemove",function(a){mousePos.x=a.clientX,mousePos.y=a.clientY}),Movable.prototype=new Transformable,Movable.prototype.constructor=Movable,Shape.prototype=new Movable,Shape.prototype.constructor=Shape,Rectangle.prototype=new Shape,Rectangle.prototype.constructor=Rectangle,Circle.prototype=new Shape,Circle.prototype.constructor=Circle,AABB.prototype=new Rectangle,AABB.prototype.constructor=AABB;var uniq=0;BC.prototype=new Circle,BC.prototype.constructor=BC,OBB.prototype=new Rectangle,OBB.prototype.constructor=OBB,window.BroadPhase={},function(a){function b(){}b.prototype.check=function(a,b,c){var d=a.length,e=[];if(!(d<2)){for(var f=0;f<d;f++)for(var g=a[f],h=f+1;h<d;h++){var i=a[h];b(g,i)&&(c&&c(g,i),e.push([g,i]))}return e}},a.BruteForce=b}(window.BroadPhase),function(a,b){function c(a,c,d,e){this.width=a,this.height=c,this.cellWidth=d||this.width/10,this.cellHeight=e||this.height/10,this.rows=Math.ceil(this.height/this.cellHeight),this.cols=Math.ceil(this.width/this.cellWidth),this.bruteForce=new b,this.grid=[]}c.prototype.resetGrid=function(){for(var a=0;a<this.rows;a++)this.grid[a]&&(this.grid[a].length=0)};var d=!1,e=0;c.prototype.check=function(a){var b=a.length;this.resetGrid(),e=0;for(var f=0;f<b;f++)for(var g=a[f],i=(new Vector2D(g.bb.getPos().x-g.bb.getOrigin().x,g.bb.getPos().y-g.bb.getOrigin().y),new Vector2D(g.bb.getExtents().x/2,g.bb.getExtents().y/2)),j=(g.x-i.x)/this.cellWidth<<0,k=(g.x+2*i.x)/this.cellWidth<<0,l=(g.y-i.y)/this.cellHeight<<0,m=(g.y+2*i.y)/this.cellHeight<<0,n=l;n<=m;n++){var o=this.grid[n];o||(o=this.grid[n]=[]);for(var p=j;p<=k;p++){var q=o[p];q||(q=this.grid[n][p]=[]),q.push(g)}}for(var t,u,v,w,r=0,s=0,x=[],y={},n=0;n<this.rows;n++){var o=this.grid[n];if(o)for(var p=0;p<this.cols;p++){var q=o[p];if(q)for(var z=0;z<q.length;z++){t=q[z];for(var A=z+1;A<q.length;A++)u=q[A],t instanceof Platform&&u instanceof Platform||(v=t._roId+":"+u._roId,w=u._roId+":"+t._roId,s+=2,y[v]||y[w]||(y[v]=y[w]=!0,r++,t.bb.collision(u.bb)&&x.push([t,u])))}}}return d=!0,x},a.HashGrid=c}(window.BroadPhase,window.BroadPhase.BruteForce),function(a,b){function c(a,b,c){this.bounds=a,this.maxDepth=b,this.maxParticles=c,this.particles=[],this.nodes=[]}c.TOP_LEFT=0,c.TOP_RIGHT=1,c.BOTTOM_LEFT=2,c.BOTTOM_RIGHT=3,c.prototype.bruteForce=new a.BruteForce,c.prototype.clear=function(){this.particles.length=0;for(var a=0;a<this.nodes.length;a++)this.nodes[a].clear();this.nodes.length=0},c.prototype.subDivide=function(){function h(d,e){return new c({x:d,y:e,width:a,height:b},f,g)}var a=this.bounds.width/2,b=this.bounds.height/2,d=this.bounds.x,e=this.bounds.y,f=this.maxDepth-1,g=this.maxParticles;this.nodes[c.TOP_LEFT]=h(d,e),this.nodes[c.TOP_RIGHT]=h(d+a,e),this.nodes[c.BOTTOM_LEFT]=h(d,e+b),this.nodes[c.BOTTOM_RIGHT]=h(d+a,e+b)},c.prototype.findQuadrant=function(a){var b=this.bounds.x+this.bounds.width/2,d=this.bounds.y+this.bounds.height/2,e=a.x+a.radius<b,f=a.x-a.radius>b,g=a.y+a.radius<d,h=a.y-a.radius>d;return g&&e?this.nodes[c.TOP_LEFT]:g&&f?this.nodes[c.TOP_RIGHT]:h&&e?this.nodes[c.BOTTOM_LEFT]:h&&f?this.nodes[c.BOTTOM_RIGHT]:void 0},c.prototype.isLeaf=function(){return 0==this.nodes.length},c.prototype.insert=function(a){if(!this.isLeaf()){var b=this.findQuadrant(a);if(b)return void b.insert(a)}if(this.particles.push(a),this.particles.length>this.maxParticles&&this.maxDepth>0){this.isLeaf()&&this.subDivide();for(var c=0;c<this.particles.length;){var b=this.findQuadrant(this.particles[c]);b?b.insert(this.particles.splice(c,1)[0]):c++}}},c.prototype.queryPossibleCollisions=function(a){var b=this.particles;if(!this.isLeaf()){var c=this.findQuadrant(a);c&&(b=b.concat(c.queryPossibleCollisions(a)))}return b},c.prototype.check=function(a,b,c){this.clear();var f,d=a.length,e=[];for(f=0;f<d;f++)this.insert(a[f]);for(f=0;f<d;f++){var g=this.queryPossibleCollisions(a[f]);e.concat(this.bruteForce.check(g,b,c))}},a.QuadTree=c}(window.BroadPhase,window.BroadPhase.BruteForce),Sprite.prototype=new Movable,Sprite.prototype.constructor=Sprite;var uniq=0;AnimatedSprite.prototype=new Movable,AnimatedSprite.prototype.constructor=AnimatedSprite;var spriteSheet=new Image;spriteSheet.width=192,spriteSheet.height=796,spriteSheet.src="../assets/spritesheet.png";var blobImage=new Image;blobImage.src="../assets/blob.png";var playerAnim=[];loadPlayerAnimations();var blobAnim=[];loadBlobAnim();var shieldImage=new Image;shieldImage.src="../assets/shield.png";var shieldAnim=new Animation(.18,shieldImage);shieldAnim.set(4,0,0,30,30);var portalInactive=new Animation(0,spriteSheet);portalInactive.set(1,0,732,32,61);var portalActive=new Animation(.1,spriteSheet);portalActive.set(5,32,732,32,61),Text.prototype=new Transformable,Text.prototype.constructor=Text;var tileSheet=new Image;tileSheet.src="../assets/tileset.png",tileSheet.width=352,tileSheet.height=32,Platform.prototype=new AnimatedSprite,Platform.prototype.constructor=Platform,PickUp.prototype=new AnimatedSprite,PickUp.prototype.constructor=PickUp,ShieldPickUp.prototype=new PickUp,ShieldPickUp.prototype.constructor=ShieldPickUp,Portal.prototype=new AnimatedSprite,Portal.prototype.constructor=Portal;var uniq=0;Entity.prototype=new AnimatedSprite,Entity.prototype.constructor=Entity,Enemy.prototype=new Entity,Enemy.prototype.constructor=Enemy,Blob.prototype=new Enemy,Blob.prototype.constructor=Blob,Goblin.prototype=new Enemy,Goblin.prototype.constructor=Goblin,Player.prototype=new Entity,Player.prototype.constructor=Player;var loaded=!1,view=new View,nextLevel=!1,canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");document.body.appendChild(canvas);var timer=new Timer,updateTimer=new Timer,scene=new Scene;scene.initialize();var i=0;window.onload=function(){window.location.hash||(window.location=window.location+"#loaded",window.location.reload())},window.requestAnimationFrame(loop);